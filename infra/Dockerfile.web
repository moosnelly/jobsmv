FROM node:20-alpine

# Install curl for healthchecks
RUN apk add --no-cache curl

WORKDIR /app

# Copy root package files
COPY package.json package-lock.json ./

# Copy all workspace package.json files
COPY apps/web/package.json ./apps/web/
COPY packages/eslint-config/package.json ./packages/eslint-config/
COPY packages/tsconfig/package.json ./packages/tsconfig/
COPY packages/types/package.json ./packages/types/
COPY packages/config/package.json ./packages/config/
COPY packages/ui-tripled/package.json ./packages/ui-tripled/

# Copy postinstall script
COPY apps/web/scripts/postinstall.js ./apps/web/scripts/

# Install all dependencies at workspace root
RUN npm ci --legacy-peer-deps

# Copy source code (excluding node_modules and other unnecessary files)
COPY apps ./apps
COPY packages ./packages

# Build the Next.js application
WORKDIR /app/apps/web
RUN npm run build

# Expose port
EXPOSE 3000

# Default command - serve the built application
CMD ["npm", "start"]

